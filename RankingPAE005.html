<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOFTWARE GAMIFICATION - Ranking Perforadores</title>
    <style>
        /* [COPY YOUR FULL CSS HERE - OMITTED FOR SPACE, TAILORED AS NEEDED] */
        /* ... (keep your CSS unchanged) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #0c1d29; min-height: 100vh; color: white; overflow-x: hidden;}
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; min-height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 40px 0; text-align: center; }
        .main-logo { max-height: 200px; max-width: 500px; object-fit: contain; filter: brightness(1.2); transition: all 0.3s ease; animation: glow 3s ease-in-out infinite alternate; }
        .main-logo:hover { transform: scale(1.05); filter: brightness(1.4);}
        @keyframes glow { from { filter: brightness(1.2) drop-shadow(0 0 10px rgba(255,255,255,0.2)); } to { filter: brightness(1.4) drop-shadow(0 0 20px rgba(255,255,255,0.4)); } }
        .page-title { font-size: 3rem; font-weight: 700; margin-top: 20px; color: #ffffff; text-shadow: 0 2px 10px rgba(0,0,0,0.3); background: linear-gradient(135deg, #ffffff, #4a90a4); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        .page-subtitle { font-size: 1.2rem; opacity: 0.8; margin-top: 10px; font-weight: 300;}
        .nav-container { text-align: center; margin-bottom: 30px; }
        .back-button { display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #134f62, #1e5f73); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 0.9rem; transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1);}
        .back-button:hover { transform: translateY(-2px); background: linear-gradient(135deg, #1e5f73, #2a7085); box-shadow: 0 6px 20px rgba(19, 79, 98, 0.4);}
        .main-content { flex: 1; padding: 20px 0 60px;}
        .ranking-container { max-width: 1000px; margin: 0 auto;}
        .ranking-header { background: linear-gradient(135deg, #283f4a, #1e5f73); border: 2px solid #134f62; border-radius: 20px 20px 0 0; padding: 25px; text-align: center; box-shadow: 0 8px 32px rgba(19, 79, 98, 0.2); }
        .ranking-title { font-size: 2rem; font-weight: 700; color: #ffffff; margin-bottom: 10px; }
        .ranking-subtitle { font-size: 1rem; opacity: 0.8; color: #e2e8f0;}
        .ranking-table { background: #283f4a; border: 2px solid #134f62; border-top: none; border-radius: 0 0 20px 20px; overflow: hidden; box-shadow: 0 8px 32px rgba(19, 79, 98, 0.2); }
        .table-header { background: linear-gradient(135deg, #134f62, #1e5f73); display: grid; grid-template-columns: 80px 1fr 200px 120px; gap: 20px; padding: 20px 25px; font-weight: 700; font-size: 1rem; color: #ffffff; text-transform: uppercase; letter-spacing: 1px;}
        .ranking-item { display: grid; grid-template-columns: 80px 1fr 200px 120px; gap: 20px; padding: 20px 25px; border-bottom: 1px solid rgba(19, 79, 98, 0.3); transition: all 0.3s ease; position: relative; align-items: center;}
        .ranking-item:hover { background: rgba(19, 79, 98, 0.2); transform: translateX(5px);}
        .ranking-item:last-child { border-bottom: none;}
        .ranking-position { font-size: 1.5rem; font-weight: 700; text-align: center; color: #4a90a4;}
        .ranking-position.gold { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);}
        .ranking-position.silver { color: #c0c0c0; text-shadow: 0 0 10px rgba(192, 192, 192, 0.5);}
        .ranking-position.bronze { color: #cd7f32; text-shadow: 0 0 10px rgba(205, 127, 50, 0.5);}
        .driller-info { display: flex; flex-direction: column;}
        .driller-name { font-size: 1.2rem; font-weight: 600; color: #ffffff; margin-bottom: 5px;}
        .driller-rig { background: linear-gradient(135deg, #134f62, #4a90a4); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-align: center; display: inline-block; width: fit-content; box-shadow: 0 2px 8px rgba(19, 79, 98, 0.3);}
        .driller-points { font-size: 1.4rem; font-weight: 700; color: #4a90a4; text-align: center; position: relative;}
        .driller-points::after { content: 'pts'; font-size: 0.7rem; opacity: 0.7; margin-left: 5px;}
        .trophy-icon { position: absolute; left: -15px; top: 50%; transform: translateY(-50%); font-size: 1.5rem; opacity: 0.8;}
        .trophy-icon.gold { color: #ffd700; }
        .trophy-icon.silver { color: #c0c0c0; }
        .trophy-icon.bronze { color: #cd7f32; }
        .loading-spinner { display: flex; justify-content: center; align-items: center; padding: 60px; color: #4a90a4;}
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(74, 144, 164, 0.3); border-top: 4px solid #4a90a4; border-radius: 50%; animation: spin 1s linear infinite;}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .error-message { text-align: center; padding: 60px 20px; color: #ff6b6b; font-size: 1.1rem;}
        .footer { padding: 40px 0; text-align: center; border-top: 1px solid #283f4a; margin-top: auto;}
        .footer-logo-section { margin-bottom: 30px;}
        .small-logo { max-height: 80px; max-width: 200px; object-fit: contain; opacity: 0.8; transition: all 0.3s ease; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(19, 79, 98, 0.2);}
        .small-logo:hover { opacity: 1; transform: scale(1.05); box-shadow: 0 6px 25px rgba(19, 79, 98, 0.3);}
        .footer-text { font-size: 0.9rem; opacity: 0.6; color: #94a3b8; }
        @media (max-width: 768px) { .page-title { font-size: 2.2rem; } .table-header, .ranking-item { grid-template-columns: 60px 1fr 80px 80px; gap: 15px; padding: 15px 20px;} .ranking-position { font-size: 1.2rem;} .driller-name { font-size: 1rem;} .driller-rig { font-size: 0.75rem; padding: 3px 8px;} .driller-points { font-size: 1.1rem;} .main-logo { max-height: 150px; max-width: 375px; } }
        @media (max-width: 480px) { .container { padding: 0 15px; } .page-title { font-size: 1.8rem; } .table-header, .ranking-item { grid-template-columns: 50px 1fr 70px; gap: 10px; padding: 12px 15px; } .table-header .points-header, .driller-points { display: none; } .driller-name { font-size: 0.9rem; } .main-logo { max-height: 120px; max-width: 300px; } .small-logo { max-height: 60px; max-width: 150px; } }
        .bg-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden;}
        .bg-shape { position: absolute; background: rgba(19, 79, 98, 0.1); border-radius: 50%; animation: float 8s ease-in-out infinite; }
        .bg-shape:nth-child(1) { width: 120px; height: 120px; top: 10%; left: 5%; animation-delay: 0s;}
        .bg-shape:nth-child(2) { width: 80px; height: 80px; top: 70%; right: 10%; animation-delay: 2s; }
        .bg-shape:nth-child(3) { width: 100px; height: 100px; top: 40%; left: 85%; animation-delay: 4s; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; } 50% { transform: translateY(-30px) rotate(180deg); opacity: 0.6; } }
    </style>
</head>
<body>
    <div class="bg-shapes">
        <div class="bg-shape"></div>
        <div class="bg-shape"></div>
        <div class="bg-shape"></div>
    </div>

    <div class="container">
        <!-- Header with Main Logo -->
        <header class="header">
            <img src="images/pae_logo_branco.png" alt="Pan America Energy" class="main-logo">
            <h1 class="page-title">RANKING PERFORADORES</h1>
            <p class="page-subtitle">CLASIFICACI√ìN EN TIEMPO REAL POR PUNTOS</p>
        </header>

        <!-- Navigation -->
        <div class="nav-container">
            <a href="index.html" class="back-button">‚Üê Volver al Portal Principal</a>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="ranking-container">
                <div class="ranking-header">
                    <h2 class="ranking-title">üèÜ TOP PERFORADORES PAE-002</h2>
                    <p class="ranking-subtitle">Clasificaci√≥n PAE-002 - √öltimos 15 d√≠as</p>
                </div>

                <div class="ranking-table">
                    <div class="table-header">
                        <div>POS</div>
                        <div>PERFORADOR</div>
                        <div>PLATAFORMA</div>
                        <div class="points-header">PUNTOS</div>
                    </div>

                    <div id="ranking-list">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span style="margin-left: 15px;">Cargando ranking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer with Small Logo -->
        <footer class="footer">
            <div class="footer-logo-section">
                <img src="images/rzx_logo.png" alt="Logo Secundario" class="small-logo">
            </div>
            <p class="footer-text">&copy; 2025 RZX Tecnolog√≠a. Todos los derechos reservados.</p>
        </footer>
    </div>

    <!-- DataManager JS EMBEDDED AS MODULE-LIKE IN THIS FILE -->
    <script>
        // DataManager adapted as plain JS object and attached to window
        (function() {
            class DataManager {
                constructor() {
                    this.rawData = [];
                    this.processedData = [];
                    this.lastUpdated = null;
                    this.csvPath = 'data/ranking_data.csv';
                }

                async loadCSVData() {
                    try {
                        const response = await fetch(this.csvPath + '?' + Date.now()); // cachebusting
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const csvText = await response.text();
                        this.rawData = this.parseCSV(csvText);
                        this.processedData = this.processRawData(this.rawData);
                        this.lastUpdated = new Date();
                        return this.processedData;
                    } catch (error) {
                        // Fallback sample data
                        this.processedData = this.getFallbackData();
                        this.lastUpdated = new Date();
                        return this.processedData;
                    }
                }

                parseCSV(csvText) {
                    // Detect separator (support for ; as well)
                    let lines = csvText.trim().split(/\r?\n/);
                    let delimiter = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : ',';
                    let headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
                    // Try to map them (disambiguate columns)
                    let colIndex = (name) => headers.findIndex(h => h.indexOf(name) !== -1);
                    let idxEq    = colIndex('equipo');
                    let idxNombre = colIndex('nombre');
                    let idxApellido = colIndex('apellido');
                    let idxPlataforma = colIndex('plataforma');
                    let idxPozo = colIndex('pozo');
                    let idxFecha = colIndex('fecha');
                    let idxTurno = colIndex('turno') >= 0 ? colIndex('turno') : colIndex('guardia');
                    let idxScoreGeneral = colIndex('puntuaci√≥n general'); //allow acentos!
                    if (idxScoreGeneral < 0) idxScoreGeneral = colIndex('score general');
                    if (idxScoreGeneral < 0) idxScoreGeneral = colIndex('puntuacion general');
                    let idxNumActividadesDia = colIndex('n√∫mero de actividades del d√≠a');
                    let idxScorePerforador = colIndex('puntuaci√≥n del perforador');
                    if (idxScorePerforador < 0) idxScorePerforador = colIndex('score perforador');
                    let idxNumActividadesPerforador = colIndex('n√∫mero de actividades del perforador');

                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        let values = lines[i].split(delimiter).map(v => v.trim());
                        if (values.length < headers.length) continue;
                        let obj = {
                            equipo: idxEq >= 0 ? values[idxEq] : "",
                            nombre: idxNombre >= 0 ? values[idxNombre] : "",
                            apellido: idxApellido >= 0 ? values[idxApellido] : "",
                            plataforma: idxPlataforma >= 0 ? values[idxPlataforma] : "",
                            pozo: idxPozo >= 0 ? values[idxPozo] : "",
                            fecha: this.parseDateRaw(values[idxFecha]),
                            turno: idxTurno >= 0 ? values[idxTurno] : "",
                            scoreGeneral: idxScoreGeneral >= 0 ? parseFloat(values[idxScoreGeneral]) || 0 : 0,
                            numActividadesDia: idxNumActividadesDia >= 0 ? parseInt(values[idxNumActividadesDia]) || 0 : 0,
                            scorePerforador: idxScorePerforador >= 0 ? parseFloat(values[idxScorePerforador]) || 0 : 0,
                            numActividadesPerforador: idxNumActividadesPerforador >= 0 ? parseInt(values[idxNumActividadesPerforador]) || 0 : 0,
                        };
                        data.push(obj);
                    }
                    return data;
                }

                processRawData(rawData) {
                    return rawData.map(item => {
                        const nombreCompleto = (item.nombre || "") + " " + (item.apellido || "");
                        // Use plataforma (csv) for rig
                        return {
                            id: (item.nombre + "_" + item.apellido).toLowerCase().replace(/\s+/g, '_'),
                            nombre: item.nombre || "",
                            apellido: item.apellido || "",
                            nombreCompleto: nombreCompleto,
                            plataforma: item.plataforma || "",
                            pozo: item.pozo || "",
                            fecha: item.fecha,
                            turno: item.turno || "",
                            scoreGeneral: item.scoreGeneral || 0,
                            numActividadesDia: item.numActividadesDia || 0,
                            scorePerforador: item.scorePerforador || 0,
                            numActividadesPerforador: item.numActividadesPerforador || 0,
                            puntosTotales: (item.scoreGeneral || 0) + (item.scorePerforador || 0)
                        }
                    });
                }

                // Robust date parser for DD/MM/YYYY, YYYY-MM-DD, etc.
                parseDateRaw(dateString) {
                    if (!dateString) return null;
                    dateString = dateString.trim();
                    let d = null;
                    // YYYY-MM-DD
                    if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                        d = new Date(dateString.substr(0,10));
                    }
                    // DD/MM/YYYY
                    else if (/^\d{2}\/\d{2}\/\d{4}/.test(dateString)) {
                        let [d1, m1, y1] = dateString.split("/");
                        d = new Date(+y1, +m1 - 1, +d1);
                    }
                    // DD-MM-YYYY
                    else if (/^\d{2}-\d{2}-\d{4}/.test(dateString)) {
                        let [d1, m1, y1] = dateString.split("-");
                        d = new Date(+y1, +m1 - 1, +d1);
                    }
                    // Try parsing directly if above fails
                    if (!d || isNaN(d.getTime())) {
                        d = new Date(dateString);
                    }
                    if (isNaN(d.getTime())) return null;
                    // For filtering, we always use the date only (00:00)
                    d.setHours(0,0,0,0);
                    return d;
                }

                getFallbackData() {
                    return [
                        { id: "juan_perez", nombre: "Juan", apellido: "P√©rez", nombreCompleto: "Juan P√©rez", plataforma: "PAE-002", pozo: "Pozo 1", fecha: new Date(2024,2,2), turno: "Tarde", scoreGeneral: 75, scorePerforador: 80, puntosTotales: 155 },
                        { id: "ana_garcia", nombre: "Ana", apellido: "Garc√≠a", nombreCompleto: "Ana Garc√≠a", plataforma: "PAE-002", pozo: "Pozo 1", fecha: new Date(2024,2,6), turno: "Ma√±ana", scoreGeneral: 75, scorePerforador: 70, puntosTotales: 145 },
                        { id: "luis_lopez", nombre: "Luis", apellido: "L√≥pez", nombreCompleto: "Luis L√≥pez", plataforma: "PAE-002", pozo: "Pozo 2", fecha: new Date(2024,2,7), turno: "Tarde", scoreGeneral: 95, scorePerforador: 50, puntosTotales: 145 },
                        { id: "pedro_ramirez", nombre: "Pedro", apellido: "Ramirez", nombreCompleto: "Pedro Ramirez", plataforma: "PAE-002", pozo: "Pozo 10", fecha: new Date(2024,1,19), turno: "Noche", scoreGeneral: 60, scorePerforador: 75, puntosTotales: 135 }
                    ];
                }

                // Returns ranking array for the last <days> days, one rig, summed by driller
                getRankingForRigLastDays(rig, days = 15) {
                    const now = new Date();
                    now.setHours(0,0,0,0);
                    const msInDay = 86400000;
                    const minDate = new Date(now.getTime() - (days-1)*msInDay);

                    let arr = this.processedData && this.processedData.length > 0
                        ? this.processedData
                        : this.getFallbackData();

                    // Filter only selected rig and last <days>
                    arr = arr.filter(row => (
                        (typeof row.plataforma === "string" && row.plataforma.toUpperCase() === String(rig).toUpperCase())
                        && row.fecha && (row.fecha >= minDate && row.fecha <= now)
                    ));

                    // Group by driller id
                    let rankingMap = new Map();
                    for (let row of arr) {
                        let id = row.id || ((row.nombre + "_" + row.apellido).toLowerCase().replace(/\s+/g, '_'));
                        if (!rankingMap.has(id)) {
                            rankingMap.set(id, {
                                name: row.nombre,
                                surname: row.apellido,
                                rig: row.plataforma,
                                points: 0,
                                latestActivity: row.fecha
                            });
                        }
                        let rec = rankingMap.get(id);
                        rec.points += Number(row.puntosTotales || 0);
                        // Keep the most recent rig and activity
                        if(row.fecha && rec.latestActivity < row.fecha){ rec.rig = row.plataforma; rec.latestActivity=row.fecha;}
                    }
                    // To array and sort by points desc
                    const rankingArr = Array.from(rankingMap.values()).sort((a, b) => b.points - a.points);
                    return rankingArr;
                }
            }
            window.dataManager = new DataManager();
        })();
    </script>

    <!-- Main ranking logic -->
    <script>
        function displayRanking(data) {
            const rankingList = document.getElementById('ranking-list');
            if (!data || data.length === 0) {
                rankingList.innerHTML = `
                    <div class="error-message">
                        üìä No hay datos de ranking disponibles
                        <br><br>
                        <small>Verifique que el archivo CSV est√© disponible</small>
                    </div>`;
                return;
            }

            const rankingHTML = data.map((driller, index) => {
                const pos = index + 1;
                let positionClass = "", trophyIcon = "";
                if(pos === 1) { positionClass="gold"; trophyIcon = '<span class="trophy-icon gold">ü•á</span>'; }
                else if(pos === 2) { positionClass="silver"; trophyIcon = '<span class="trophy-icon silver">ü•à</span>'; }
                else if(pos === 3) { positionClass="bronze"; trophyIcon = '<span class="trophy-icon bronze">ü•â</span>'; }
                return `
                    <div class="ranking-item">
                        ${trophyIcon}
                        <div class="ranking-position ${positionClass}">#${pos}</div>
                        <div class="driller-info">
                            <div class="driller-name">${driller.name || ""} ${driller.surname || ""}</div>
                            <div class="driller-rig">${driller.rig || ""}</div>
                        </div>
                        <div></div>
                        <div class="driller-points">${driller.points.toLocaleString()}</div>
                    </div>
                `;
            }).join("");
            rankingList.innerHTML = rankingHTML;
        }

        async function loadRankingData() {
            try {
                await window.dataManager.loadCSVData();
                const data = window.dataManager.getRankingForRigLastDays('PAE-002', 15);
                displayRanking(data);
            } catch (error) {
                document.getElementById('ranking-list').innerHTML = `
                    <div class="error-message">
                        ‚ùå Error al cargar los datos del ranking
                        <br><br>
                        <small>Error: ${error.message}</small>
                        <br><br>
                        <small>Verifique que el archivo data/ranking_data.csv est√© disponible</small>
                    </div>
                `;
            }
        }

        // Auto-refresh every 5 min
        setInterval(loadRankingData, 5*60*1000);

        document.addEventListener('DOMContentLoaded', () => {
            loadRankingData();
        });

        // Optional: leave back button js as is (direct link)
    </script>
</body>
</html>
